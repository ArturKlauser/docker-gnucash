# nginx config for using oauth2-proxy with auth_request
#
# Enable authentication check for all requests.
auth_request /oauth2/auth;

# Public OAuth2 Endpoints (Sign-in/Callback)
location /oauth2/ {
  auth_request off;
  proxy_pass http://unix:/tmp/oauth2-proxy.sock;
  proxy_set_header Host $http_host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Scheme $scheme;
  proxy_set_header X-Auth-Request-Redirect $request_uri;
}

# Hardened Internal Auth Check (Optimized)
location = /oauth2/auth {
  internal;
  proxy_pass http://unix:/tmp/oauth2-proxy.sock;
  proxy_set_header Host $http_host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Scheme $scheme;
  proxy_set_header X-Forwarded-Uri $request_uri;

  # Optimization: Disable buffering and body passing for fast sub-requests
  proxy_buffering off;
  proxy_pass_request_body off;
  proxy_set_header Content-Length "";
}

# Endpoint to perform the logout.
location = /logout {
  auth_request off;
  # Pass information of the sender.
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Real-IP $remote_addr;

  # Forward to oauth2-proxy sign out.
  # Note: oauth2-proxy handles the redirect after logout via `rd` query param
  # or `whitelist_domains`.
  return 302 /oauth2/sign_out?rd=$scheme://$http_host/;
}

# Redirect to the login page if the /oauth2/auth endpoint returns
# `401 not authorized`.
error_page 401 = @oauth2_signin;

# Named location for handling OAuth2 sign-in redirects. This ensures the browser
# receives a proper 302 redirect that it will follow.
location @oauth2_signin {
  return 302 /oauth2/sign_in?rd=$scheme://$http_host$request_uri;
}

# Pass information via X-User and X-Email headers to backend. Requires running
# with --set-xauthrequest flag.
auth_request_set $user $upstream_http_x_auth_request_user;
auth_request_set $email $upstream_http_x_auth_request_email;
proxy_set_header X-User $user;
proxy_set_header X-Email $email;
